{% extends "intents_base.html" %}

{% block angularjs_ng_app %}
ng-app='appIntentsEdit' ng-controller='ctrlIntentsEdit' ng-init='getIntentsEditData();'
{% endblock %}

{% block content %}
    <h3>editing</h3>
    <h1>{{ intent.intent_name }}</h1>
    <div id='debug'></div>
    <!-- <label for='deployed'>deployed</label>
    <input type='checkbox' name='deployed' {% if intent.deployed %}checked{% endif %}>
    <label for='deployed'>deployed</label>
    <input type='checkbox' name='deployed' {% if intent.deployed %}checked{% endif %}> -->
    <hr style='width: 97%;'>
    <div id='debug'></div>
        
    <div id='error'></div>
    
    {#
    {% with messages = get_flashed_messages() %}
        {% if messages %}
        <ul class='flashed-message'>
            {% for message in messages %}
            <li>{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    {% endwith %}
    #}
    
    <div id="switches">
        <div>
            <div>Deployed</div>
            <md-switch ng-model="switches.deployed" aria-label="deployed_switch" ng-change="toggle({{ intent.id }}, 'deployed');"></md-switch>
        </div>
        <div>
            <div>Casual</div>
            <md-switch ng-model="switches.small_talk" aria-label="casual_switch" ng-change="toggle({{ intent.id }}, 'small_talk');"></md-switch>
        </div>
    </div>
    
    <h2>Chatbot response</h2>
    <div id='reply-messages-container'>
        <!-- <input type='submit' name='english' value='english'>
        <input type='submit' name='malay' value='malay'> -->
        {% set target = intent %}
        {% set category = 'reply-message' %}
        {% set languages = ['en', 'my'] %}
        {% for response in responses %}<a href="#select-language-button_{{ response.lang }}" class='select-language-button' id='select-language-button_{{ response.lang }}' 
            onclick="cancel_edit_space_reply_all('{{ category }}')">{{ response.lang[:2] }}</a>{% endfor %}
        <div id='reply-messages'>
            {% for response in responses %}
                <div class='{{ category }}-language-section' id='{{ category }}-language-section_{{ response.lang }}'>
                    <div id='{{ category }}-display_{{ response.lang }}' class='{{ category }}-display'>
                        <span id='{{ category }}_{{ response.lang }}' class="editable-content">{{ response.text }}</span>
                        <input id='edit-button_{{ response.lang }}' class='edit-button' type='submit' value='edit' onclick="show_edit_space_reply(this.id, '{{ category }}')">
                    </div>
                    <div id='{{ category }}-edit_{{ response.lang }}' class='editable-edit' style='display:None;'>
                        <!-- <span class='utterance'>editting</span> -->
                        <form action="" method='POST'>
                            <input type="hidden" name="lang" value="{{ response.lang }}">
                            <input type="hidden" name="job" value="update_reply_message">
                            <textarea style='height:60px;' class='editable-content' name='modified_content' id='{{ category }}-e_{{ response.lang }}' ori_value='{{ response.text }}' required>{{ response.text }}</textarea>
                            <!-- <input id='save-button_{{ response.lang }}' class='save-button' type='submit' value='save'>
                            <input id='cancel-button_{{ response.lang }}' class='cancel-button' type='submit' form='' value='cancel' onclick="cancel_edit_space_reply(this.id, '{{ category }}')"> -->
                            <button id='save-button_{{ response.lang }}' class='save-button' type='submit'>save</button>
                            <button id='cancel-button_{{ response.lang }}' class='cancel-button' type='submit' form='' onclick="cancel_edit_space_reply(this.id, '{{ category }}')">cancel</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <h2>Training samples</h2>
    <div id='training-samples'>
        {% set category='user-message' %}
        {% set wrapped=False %}
        {% set data='data_intents_edit' %}
        {% set text='user_message' %}
        {% include 'editable.html' %}

        {% set category = 'add-intent' %}
        {% set placeholder = 69 %}
        <div class='editable' id='add-intent-box' style='padding: 0 10px;'>
            <!-- <div>hello</div> -->
            <input id='{{ category }}-display_{{ placeholder }}' class='add-button' type='submit' value='+' onclick="show_edit_space(this.id, '{{ category }}')">
            <div id='{{ category }}-edit_{{ placeholder }}' class='editable-edit' style='display: none; padding: 5px 0'>
                <form action='' method='POST'>
                    <!-- <input type="hidden" name="job" value="add_sample"> -->
                    <textarea class='editable-content' cols=2 name='user_message' id='{{ category }}-e_{{ placeholder }}' 
                        ng-model='add_intent_form.user_message' ori_value='' required></textarea>
                    <!-- <input id='cancel-button_{{ placeholder }}' class='cancel-button' type='submit' value='cancel' form='' onclick="cancel_edit_space(this.id, '{{ category }}')">
                    <input id='save-button_{{ placeholder }}' class='save-button' type='submit' value='save'> -->
                    <button id='save-button_{{ placeholder }}' class='save-button' type='submit' form='' 
                        ng-click="addSample($event, '{{ category }}');">save</button>
                    <button id='cancel-button_{{ placeholder }}' class='cancel-button' type='submit' form='' 
                        onclick="cancel_edit_space(this.id, '{{ category }}')">cancel</button>
                </form>
            </div>
        </div>
    </div>

    {% include 'jinja.jinja-html' %}
    <script>
        function cascade_zindex(clicked_elem) {
            buttons = document.getElementsByClassName(clicked_elem.className);
            clicked_elem_index = 0;
            for (i = 0; i < buttons.length; i++) {
                if (buttons[i].id == clicked_elem.id) {
                    clicked_elem_index = i;
                    break;
                }
            }

            for (i = 0; i < buttons.length; i++) {
                if (i != clicked_elem_index) {
                    buttons[i].style.zIndex = 50 - Math.abs(clicked_elem_index - i);
                } else {
                    buttons[i].style.zIndex = 51;
                }
            }
        }

        $(document).ready(function() {
            buttons_text = document.getElementsByClassName('select-language-button');
            for (i = 0; i < buttons_text.length; i++) {
                buttons_text[i].addEventListener('click', function(event) {cascade_zindex(event.target);})
            }

            document.getElementById('select-language-button_{% if language %}{{ language }}{% else %}{% if primary_lang %}{{primary_lang}}{% else %}en{% endif %}{% endif %}').click();

            // var error_messages = {{ get_flashed_messages() | tojson | safe }};
            // flashError(error_messages);
            var error_messages = get_flashed();
            flashFlashed();
        });

        // angular.element(document).ready(function() {
        //     document.getElementsByClassName('flex-item-right')[0].scrollTo(0, 0);
        // });

        function show_edit_space_reply(id, category) {
            var edit_buttons = $(".reply-message-language-section").find('.edit-button');
            for (i = 0; i < edit_buttons.length; i++) {
                edit_buttons[i].style.display = 'none';
            }
            show_edit_space(id, category);
        }

        function cancel_edit_space_reply(id, category) {
            var edit_buttons = $(".reply-message-language-section").find('.edit-button');
            for (i = 0; i < edit_buttons.length; i++) {
                edit_buttons[i].style.display = 'inline';
            }

            if (Array.isArray(id)) for (i = 0; i < id.length; i++) cancel_edit_space(id[i], category);
            else cancel_edit_space(id, category);
        }

        function cancel_edit_space_reply_all(category) {
            all_languages_button = document.getElementsByClassName('select-language-button');
            all_languages = [];
            for (i = 0; i < all_languages_button.length; i++) {
                all_languages.push(all_languages_button[i].id);
            }
            cancel_edit_space_reply(all_languages, category);
        }

        var appIntentsEdit = angular.module('appIntentsEdit', ['ngMaterial', 'ngMessages']);

        appIntentsEdit.config(['$interpolateProvider', function($interpolateProvider) {
            $interpolateProvider.startSymbol('{a');
            $interpolateProvider.endSymbol('a}');
        }]);

        appIntentsEdit.controller('ctrlIntentsEdit', function ctrlIntentsEdit($scope, $http) {
            $scope.data_intents_edit = [];
            $scope.dummy;
            $scope.switches = {
                'deployed': false, 
                'small_talk': false
            };
            $scope.add_intent_form = {
                'intent_id': parseInt("{{ intent.id }}"), 
                'user_message': ''
            }
            
            $scope.getIntentsEditData = function getIntentsEditData() {
                $http.post('/view_intents_edit', {'intent_id': '{{ intent.id }}'})
                .then(
                    function(response)
                        {
                            $scope.data_intents_edit = response.data.training_data;
                            $scope.switches.deployed = response.data.deployed;
                            $scope.switches.small_talk = response.data.small_talk;
                        }, 
                    function(response)
                        {
                            console.log('getIntentsEditData error');
                            console.log(response);
                        }
                );
                // error handling
            };

            $scope.toggle = function(intent_id, field) {
                var ori = !$scope.switches[field];

                var data = {};
                data['intent_id'] = intent_id;
                data['value'] = $scope.switches[field];
                data['field'] = field;
                console.log(data);

                $http.post('/intents_edit/toggle', data)
                .then(
                    function(response)
                        {
                            console.log(response);
                            $scope.getIntentsEditData();
                        }, 
                    function(response)
                        {
                            console.log(`toggle ${field} error`);
                            $scope.switches[field] = ori;
                        }
                )
            }

            $scope.submitForm = function submitForm(target, job) {
                var form = document.getElementById('form-'+job+'_'+target.id);
                var form_data = {};
                for (i = 0; i < form.elements.length; i++) {
                    var elem = form.elements[i];
                    if (elem.type != 'submit') form_data[elem.name] = elem.value;
                }
                console.log(form_data);

                $http.post('/intents_edit/{{ intent.intent_name }}', form_data)
                .then(
                    function(response)
                        {
                            // $scope.dummy = form_data;
                            console.log(form_data);
                            console.log(response);
                            $scope.getIntentsEditData();
                        }, 
                    ajaxErrorHandle
                );
            };

            $scope.addSample = function(event, category) {
                var intent_id = $scope.add_intent_form.intent_id;
                var user_message = $scope.add_intent_form.user_message;

                if (!user_message) {
                    alert('This field cannot be left empty');
                    return;
                }

                form_data = {'intent_id': intent_id, 'user_message': user_message};

                $http.post('/intents_edit/add_sample', form_data)
                .then(
                    function(response)
                        {
                            console.log(form_data);
                            console.log(response);
                            $scope.getIntentsEditData();
                        }, 
                    ajaxErrorHandle
                );

                cancel_edit_space(event.target.id, category);
            }
        });

        // window.onload = function() {
        //     document.getElementById('select-language-button_en').trigger('click');
        // };
    </script>
{% endblock %}